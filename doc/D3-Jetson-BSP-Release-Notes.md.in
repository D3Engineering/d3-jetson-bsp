---
x-note: @configure_input@
title: D3 Jetson BSP v@VERSION_NAME@ Release Notes
linkcolor: black
toc: true
toc-title: \empty
toc-own-page: true
listings-no-page-break: true
titlepage: true
header-includes: |
 \usepackage{booktabs}
 \usepackage{graphicx}
 \usepackage{textcomp}
 \usepackage[table]{xcolor}
 \usepackage{graphicx}
 \usepackage{caption}
 \usepackage{titling}
 \usepackage{transparent}
 \usepackage{float}
 \usepackage{array}

 \usepackage{pifont,mdframed}
 \newenvironment{warning}
  {\par\begin{mdframed}[nobreak=true,linewidth=2pt,linecolor=red]%
    \begin{list}{}{\leftmargin=1cm
                   \labelwidth=\leftmargin}\item[\Large\ding{43}]}
  {\end{list}\end{mdframed}\par}
 \newenvironment{notice}
  {\par\begin{mdframed}[nobreak=true,linewidth=2pt,linecolor=black]%
    \begin{list}{}{\leftmargin=1cm
                   \labelwidth=\leftmargin}\item[\ding{43}]}
  {\end{list}\end{mdframed}\par}
---
\lstset{
    language=bash,
    breaklines=true,
}


\renewcommand{\thempfootnote}{\arabic{mpfootnote}}

\makeatletter
\renewcommand{\fps@figure}{!ht}
\renewcommand{\fps@table}{!ht}
\makeatother

\newcommand{\imx}{D3CM-IMX390{} }
\newcommand{\imxrcm}{D3RCM-IMX390-953{} }
\newcommand{\ov}{D3RCM-OV10640-953{} }
\newcommand{\ovnone}{OV10640 }
\newcommand{\ovnones}{OV10640s }
\newcommand{\imxnone}{IMX390 }
\newcommand{\imxrcmnone}{IMX390RCM }
\newcommand{\nvidia}{NVIDIA\textregistered{} }
\newcommand{\nvjetsonntm}{\nvidia Jetson }
\newcommand{\nvjetson}{\nvjetsonntm\texttrademark{} }
\newcommand{\nvxavier}{\nvjetsonntm AGX XAVIER\texttrademark{} }
\newcommand{\nvxavierntm}{\nvjetsonntm AGX XAVIER }
\newcommand{\nvnx}{XAVIER\texttrademark{} NX }

\newcommand{\fpdlink}{FPD-LINK\texttrademark{} III{} }
\newcommand{\designcore}{DesignCore\textregistered{} }

\newcommand{\rspnamelong}{\designcore{} RSP-TX2 Development Kit - \fpdlink{} }
\newcommand{\rspnameshort}{RSP-TX2 Development Kit - \fpdlink{} }

\newcommand{\cicnamelong}{\designcore \nvjetsonntm SerDes Interface Card{} }
\newcommand{\cicnameshort}{\nvjetson SerDes Interface Card{} }

\newcommand{\dbloctonamelong}{\designcore \nvxavierntm \fpdlink INTERFACE CARD{} }
\newcommand{\dbloctonameshort}{\nvxavier \fpdlink INTERFACE CARD{} }
\newcommand{\nxcnameshort}{D3 NX Carrier Board{} }
\newcommand{\nxcnamelong}{\designcore \nvjetsonntm \nvnx 12-Camera Carrier Board{} }
\newcommand{\sdkmanager}{\nvidia SDK Manager{} }

\newcommand{\nvjetpack}{NVIDIA JetPack\texttrademark{} }

\listoffigures
\listoftables

# D3 Jetson BSP v@VERSION_NAME@

This release supports and requires \nvjetpack @JP_VERSION@. It contains
numerous D3 bug fixes and improvements.

\begin{warning}

Selecting camera types has changed for all systems. The camera type
must explicitly be configured before cameras are detected. We have
provided a terminal UI for this purpose. Please see
\hyperlink{selecting-camera-type}{Selecting Camera Type} for more
information.

\end{warning}


# Major Changes


* \nvjetpack @JP_VERSION@ supported and required

* Removed support for Tx2, \imxnone 2-lane, and the VG6768 sensor

* Added support for TCv3 (Tone Curve Version 3) for \imxnone and \ovnone for improved HDR performance

* Update \imxnone drivers to disable the Safety Mechanism Pattern Generator\newline
  Please note that this changes the height for \imxnone to 1096 instead of 1100

* \ovnones have significantly faster startup times for streams to avoid Argus timeouts

* Fix issues with \ovnone strapping pins for fewer failures on cold boots

* Improve BSP Release Notes

* Refactored internal product code-names in favor of more intuitive ones

* The filesystem is now used to hold the device-tree file instead of the dedicated partition

* Fixed support for M2.M NVMe drives for the \nxcnameshort by preventing the
 3v3 power rail from falling during the boot sequence

# Supported Hardware

This release supports the following hardware combinations.

\begin{table}[h]
\begin{minipage}{\textwidth}
\centering
\caption{Supported Hardware Combinations}
\label{tab:supported-camera-modules}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}lll@{}}
\toprule

Hardware Combination & \ovnone & \imxnone \\

\midrule

\nxcnamelong \\ (SKU: 1001211) & 12 & 12 \\

\nvxavier Developer Kit with \dbloctonamelong \\ (SKU: 1000971)
&  16 & 16 \\

\nvxavier Developer Kit with \cicnamelong \\ (SKU: 1000800)
&  4 & 4 \\

\bottomrule
\end{tabular}%
}
\end{minipage}
\end{table}


\begin{table}[h]
\centering
\caption{Supported Camera Modules}
\label{tab:supported-camera-modules}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}lll@{}}
\toprule
Model & Image Sensor & SKU \\ \midrule
\designcore \imx & SONY\textregistered{} IMX390 & 1000406 \\
\designcore \imxrcm Rugged & SONY\textregistered{} IMX390 & 1000843, 1000844 \\
\designcore \ov Rugged & OmniVision Technologies OV10640 & 1000581, 1000508 \\ \bottomrule
\end{tabular}%
}
\end{table}


\newpage
# Installation

The basic steps for installing the D3 BSP on Jetson targets is as follows:

1. Install \nvjetpack @JP_VERSION@.

2. For \nxcnameshort manually flash the device tree.

3. Install the linux-image and d3-jetson-util packages on the target.

4. Flash the correct device tree unless already performed in step 2.


\begin{warning}
We currently advise against running `apt upgrade` on development systems.
If you wish to do so, you must disable \nvidia's apt repositories. Running
`apt upgrade` without doing so may cause your system to upgrade the JetPack
version and overwrite D3 BSP changes.
\end{warning}

## Installing \nvjetpack @JP_VERSION@

If the target does not already have \nvjetpack @JP_VERSION@ installed use
\sdkmanager to download and install the \nvjetpack on the host and on the
target. \sdkmanager can be downloaded
[here](https://developer.nvidia.com/nvidia-sdk-manager).

The \sdkmanager software must run from an Ubuntu 18.04 or 16.04 host
computer. Virtual machines are not currently supported by \nvidia.
Additional documentation for \sdkmanager is provided by \nvidia at
this [location](https://docs.nvidia.com/sdk-manager/index.html).

\begin{warning}
When flashing \nxcnameshort, additional steps are required to use
the board for development. Please refer to the \nxcnameshort specific
manual for detailed procedures. This is included as a separate
PDF with this release. Please see `D3-Jetson-NX-Carrier-Bringup.pdf`.
\end{warning}


## Manually Installing a DTB from the Host

\hypertarget{installing-a-dtb}{\empty}This section applies only to
\nxcnameshort after flashing using \sdkmanager. For all other D3
products this section can be skipped.

Assuming that \sdkmanager installed \nvjetpack to its default location then the
`Linux_for_Tegra` directory ($L4TDIR) on the host machine will be located at
`~/nvidia/nvidia_sdk/JetPack_@JP_VERSION@_Linux_JETSON_AGX_XAVIER/Linux_for_Tegra.`
The "Jetson\_AGX\_XAVIER" part of that file path may differ depending on
your current Jetson target. It may instead be "Linux\_JETSON\_XAVIER\_NX", for
example.

Perform the following steps:

1. Change the working directory to $L4TDIR on the host computer.

1. Copy the target \*.dtb from the D3 BSP release into
   `./kernel/dtb/`. The target dtb is copied into `./kernel/dtb/` because
   `flash.sh` requires it in this location for flashing.

2. Put the \nxcnameshort into recovery mode by holding the recovery
   button while pressing and releasing the reset button.

3. From the host computer run flash.sh with the following arguments
   `./flash.sh -k kernel-dtb -d ./kernel/dtb/d3-nxc-fpdlink.dtb jetson-xavier-nx-devkit-emmc mmcblk0p1`

Once the board is flashed with the correct dtb there should be video
output on HDMI and the normal D3 installation procedure can be
followed.

\newpage
## Installing D3 Kernel and Utilities Packages {#kernel_and_utils}

The D3 Jetson kernel is provided in binary form packaged as Debian
package files (i.e. .deb files). The following is a list of the different
package files, with required ones marked accordingly.
\begin{table}
\begin{center}
\begin{tabular}{ | c | m{9.3cm} | m{3.8cm} | }
\hline
Required & File & Description\\ \hline
Yes & d3-jetson-util\_@D3_JETSON_BSP_VERSION@-1\_arm64.deb & Contains all\
of the utilities of the BSP such as camera selection and the D3 supported\
camera settings. \\
\hline
Yes & linux-image-@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+\_1\_arm64.deb\
& Contains the Linux kernel, its modules, and their corresponding files\
needed to boot a system. \\
\hline
No & linux-headers-@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+\_1\_arm64.deb\
& Contains all the headers required to build external kernel modules. \\
\hline
No & linux-firmware-image-@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+\_1\_arm64.deb\
& Contains the firmware used by the Linux kernel. \\
\hline
No & linux-libc-dev\_1\_arm64.deb & Contains files required to build userspace\
programs. These headers are used by GNU glibc and other system libraries. \\
\hline
\end{tabular}
\end{center}
\end{table}

Perform the following steps on the target computer (the \nvjetson) to install
the D3 kernel and its supporting packages.

\begin{warning}

The default Ubuntu image from \nvidia disables installation of
documentation from packages. The first step in the installation is to
re-enable installation of documentation. This is important because D3
installs example scripts in the documentation area; without this step
the example scripts will be missing!

\end{warning}


\begin{notice}

When linux-image-@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+\_1\_arm64.deb is installed you will see notices that say things like the following.

\begin{quote}
Hmm. The package shipped with a symbolic link /lib/modules/@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+/source
However, I can not read the target: No such file or directory
Therefore, I am deleting /lib/modules/@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+/source
\end{quote}

This notice can safely be ignored.

\end{notice}

When installing
`linux-image-@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+_1_arm64.deb`, you may
be asked "What do you want to do about modified configuration file
`kernel-img.conf`?" (see "Package configuration" image below).  Select "install
the package maintainer's version" as depicted in the image below.

\begin{figure}[h]
\caption{Kernel Package Configuration}
\centering
\includegraphics[width=\textwidth]{img/d3-kernel-maintainer.png}
\end{figure}

These steps will install the D3 kernel and D3 utilities.

```sh
# Remove this file or the example scripts will not be included!
sudo rm -f /etc/dpkg/dpkg.cfg.d/excludes

# Update package lists for dependencies
sudo apt update

# Install the kernel and D3 supporting tools
# This will prompt for a DTB file selection
sudo apt install \
  ./linux-image-@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+_1_arm64.deb \
  ./d3-jetson-util_@VERSION_NAME@-1_arm64.deb

# Optional (but recommended) packages
sudo apt install \
  ./linux-firmware-image-@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+_1_arm64.deb\
  ./linux-headers-@D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+\_1\_arm64.deb \
  ./linux-libc-dev_1_arm64.deb

# Reboot the system to use the new kernel and DTB
sudo reboot
```

The `apt install` will prompt you to select a DTB file as described in the next section.

## DTB File Selection

\begin{warning}

\hypertarget{dtb-file-selection}{\empty}There are different DTB files
for different hardware combinations. The correct file must be chosen. The naming
convention is `@CUSTOMER@-[tegra platform]-[d3 board].dtb`.

Installing the wrong DTB file can result in a system that will not
boot. The system can be recovered by following the steps in
\hyperlink{installing-a-dtb}{"Manually Installing a DTB from the Host"} and choosing the correct dtb file included with the D3 BSP.

\end{warning}

\begin{table}[h]
\begin{minipage}{\textwidth}
\centering
\caption{DTB File Selection}
\label{tab:dtb-file-selection}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}lll@{}}
\toprule

Base System & Camera Type & DTB Filename \\

\midrule

\nvxavier Developer Kit with \dbloctonameshort & ALL & \nvxavier with DesignCore \nvxavier FPD-Link III Interface Card \\

\nvxavier Developer Kit with \cicnameshort & ALL & \nvxavier with DesignCore \nvidia Jetson SerDes Sensor Interface Card \\

\nxcnameshort & ALL & \nvxavier NX on DesignCore \nvxavier NX 12-Camera Carrier Board \\

\bottomrule
\end{tabular}%
}
\end{minipage}
\end{table}

The `d3-install-dtb` script provides a convenient way to update the installed
DTB. `apt` will automatically run the script towards the end of the install
process if the `.deb` is being used for installation.

Simply follow the prompts in the terminal to select the number of the desired
kernel and DTB file. See Table \ref{tab:dtb-file-selection} for more detail
about the available DTB files.


```sh
# Install the correct device tree for your board
d3-install-dtb

# Restart the system
sudo reboot
```

\begin{notice}

\begin{itemize}
  \item The kernel version reported by `uname -a` will not change until the
  system is restarted.

  \item The build IDs in the kernel and device tree will not change until
  the system is restarted.
\end{itemize}


\end{notice}

To verify that the kernel is correct, run `uname -a`. You should see
output similar to the following. The timestamp in
this document may not match your output. The important thing to verify
is that the version is @D3_JETSON_BSP_VERSION@-@CUSTOMER@.


```sh
uname -a
Linux nvidia-desktop @D3_LINUX_KERNEL_TRIPLET@+@D3_JETSON_BSP_VERSION@-@CUSTOMER@+ #1 SMP PREEMPT Wed Jun 19 10:15:08 EDT 2019 aarch64 aarch64 aarch64 GNU/Linux
```


To verify that the dtb is correct look at
`/proc/device-tree/nvidia,dtsfilename`. You should see a file name
that is very similar to the name of the dtb that was installed. As an
example, for the \nxcnameshort you would see `d3-nxc-fpdlink.dts`. You
can also verify the build time of the device tree with
`/proc/device-tree/nvidia,dtbbuildtime`. The build time in this
document may not match the build time you see but should be close in time to the build time reported by `uname -a`.

\begin{notice}

The build time file is `nvidia,dtbbuildtime`. It is not
`nvidia,dtsbuildtime`.

\end{notice}


```sh
cat /proc/device-tree/nvidia,dtsfilename
arch/arm64/boot/dts/../../../../../../hardware/d3/d3-nxc-fpdlink.dts
cat /proc/device-tree/nvidia,dtbbuildtime
Jun 18 201911:58:39
```

As an optional step you can verify that the build ID for the device
tree matches the build ID for the kernel. This indicates that the
device tree and kernel were built from the same code base at the same
time. A new build ID is generated for every build that D3 makes.

The build ID for the kernel should match the build ID for the device
tree.


\begin{notice}
The build IDs in this document may not match the build IDs on your
system.
\end{notice}


```sh
# The kernel build ID
cat /sys/module/build_id/version
e2080b9d-68d4-4d37-a906-02cc1491bd39

# The device tree build ID
cat /proc/device-tree/d3,jetson-bsp-build-id
e2080b9d-68d4-4d37-a906-02cc1491bd39
```

To verify that the cameras are operational, attach 1 to 6 cameras
(depending on your hardware configuration) and then test each
individually with either `nvgstcapture` or `argus_camera`. See this
\hyperlink{nvgst-known-issue}{known issue} regarding sensor modes with
`nvgstcapture`.

The `nvgstcapture` utility is installed by default. The `argus_camera`
utility is not installed by default. See \hyperlink{argus-camera-installation}{here} for directions to build and install `argus_camera`.
Installation and use of `argus_camera` is **strongly suggested and encouraged**.

```sh
# N is 0 to 5
nvgstcapture --sensor-id $N
```


## Connecting Cameras on \cicnameshort

\begin{figure}[H]
\caption{\cicnamelong}
\centering
\includegraphics[width=0.5\textwidth]{img/d3-6x-serdes-vc-key-points.jpg}
\end{figure}

 * Connect the camera module(s) to port(s) J6-J9, blue box.

 * Port J6 is considered the first port for fpdlink cameras, red circle


\begin{figure}[H]
\caption{\cicnamelong}
\centering
\includegraphics[width=0.5\textwidth]{img/d3-6x-serdes-jumpers.jpg}
\end{figure}

 * Port J13 and J14 should be set in-board as pictured. (see circle)

 * Supply 12 volts to the barrel connector or screw terminals, circled.

## Connecting Cameras on \dbloctonameshort

\hypertarget{connecting-dblocto}{\empty}

\begin{figure}[H]
\caption{\dbloctonamelong}
\centering
\includegraphics[width=0.5\textwidth]{img/d3-xavier-16x-fpdlink-key-points.png}
\end{figure}

 * Connect camera modules to any available port.

 * Circled and labeled are the first ports of each deserializer.

 * Supply 12 volts to the barrel connector. (see arrow)

## Removing the D3 Kernel and Utilities Packages

The D3 Utilities package automatically overwrites extlinux.conf on installation.
Due to this, in order to remove the package completely, one needs to manually
intervene after the standard package removal process.

The removal of the D3 kernel can be done with a standard `sudo apt remove` or,
to remove the accompanying configuration, `sudo apt purge`.

After the requisite files listed in section \ref{kernel_and_utils} are removed,
restore the original extlinux.conf, which was automatically backed up at
installation, with the command:
```bash
sudo cp /boot/extlinux/extlinux.conf- /boot/extlinux/extlinux.conf
```
After this action is performed, please inspect the configuration in order to
ensure that rebooting will not require re-flashing the SoM.
\newpage

# Configuration and Use

## Selecting Camera Type

\hypertarget{selecting-camera-type}{\empty}

For \nvxavier systems a kernel parameter is used to configure the camera
type for each port. This technique makes it possible to mix and match
all D3 supported camera types on a single system.

### Camera Selection Utility

The D3 BSP comes with a camera selection tool that will automatically make
changes to the kernel parameters based on your selection. This can be accessed
by using the `d3-select-cameras-boot` script that is supplied by the
d3-jetson-utils package.

The script will read the currently active device tree to find available
cameras to enable. You must install the correct device tree for your
system via `d3-install-dtb` and reboot before using the camera selection
script.

Once the main selection menu is open, you should see a list of all camera
ports available on your system. You may navigate into these using the
arrow and `<enter>` keys.

Inside the selection menu for a camera port, you will be given the option to
enable an available camera to be used on that port. Select the cameras you wish
to use via navigating with the arrow keys and selecting with `<spacebar>`.
Once you have configured the camera port, hit `<enter>` to save your selection.

Save your new configuration by moving the cursor right to select
the "Apply" button from the main menu. You will be prompted to save your
changes before they are applied.

Once saved, changes will be read by the kernel during the next boot.

### Manual Use of "active_overlays" Kernel Parameter

Kernel parameters are specified in the
`/boot/extlinux/extlinux.conf` file. This file is modified when the D3
linux-image and d3-jetson-util deb packages are installed. This file
controls which kernel is loaded along with parameters passed to the kernel.

The kernel parameter that is used for camera selection is named
`active_overlays`. This is a comma separated string that pairs camera
model names with indices that correspond to the \fpdlink input
ports of the system.


\begin{table}[h]
\begin{minipage}{\textwidth}
\centering
\caption{Camera Model Names for Active Overlays}
\label{tab:supported-camera-modules}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}ccccl@{}}
\toprule

Camera Name & SKU & Active Overlay Model Name\\

\midrule

\imx  & 1000406 & imx390\\
\imxrcm  & 1000843, 1000844 & imx390rcm\\
\ov & 1000581, 1000508 & ov10640\\

\bottomrule
\end{tabular}%
}
\end{minipage}
\end{table}


The following string configures the \nxcnameshort for 6 \ovnone
cameras. This argument is applied to the `APPEND` stanza in
`/boot/extlinux/extlinux.conf`.

`active_overlays=ov10640_0,ov10640_1,ov10640_2,ov10640_3,ov10640_4,ov10640_5`

The following string would configure the first port for an \imxnone, the
last port an \imxrcmnone and all other ports configured for \ovnone.

`active_overlays=imx390_0,ov10640_1,ov10640_2,ov10640_3,ov10640_4,imx390rcm_5`

The following string configures the \nvxavier for 4 \ovnone
cameras. This argument is applied to the `APPEND` stanza in
`/boot/extlinux/extlinux.conf`. This string sets up the first camera
of each set of 4 cameras to be enabled. For a visual representation, see
the section \hyperlink{connecting-dblocto}{Connection to \dbloctonameshort}

`active_overlays=ov10640_0,ov10640_4,ov10640_8,ov10640_12`

This is example of a full `extlinux.conf` file configured for 6 \ovnone
camera modules. The \ovnone portion is paired with a zero based index
that corresponds to the \fpdlink input ports.

```
TIMEOUT 30
DEFAULT primary

MENU TITLE D3-NxC eMMC boot options

LABEL primary
      MENU LABEL D3 Debug Kernel
      LINUX /boot/Image
      APPEND ${cbootargs} root=/dev/mmcblk0p1 rw rootwait rootfstype=ext4 active_overlays=ov10640_0,ov10640_1,ov10640_2,ov10640_3,ov10640_4,ov10640_5

LABEL nvidia
      MENU LABEL Nvidia Kernel
      LINUX /boot/Image-nvidia
      APPEND ${cbootargs} root=/dev/mmcblk0p1 rw rootwait rootfstype=ext4
```


## ISP Configuration

The d3-jetson-util package installs ISP override parameters for each
supported camera type. **Generally no action is required of the user,
other than installing the d3-jetson-util package, to make use of the
ISP tuning files.**

In the specific case of cameras that have RCCB and RGGB color filter
arrays some action must be taken to choose the correct tuning file. It
is necessary to change symbolic links so that \nvidia's Argus daemon
loads the desired ISP overrides file.

To configure the system to use a different ISP override file you must
change the correct symbolic link in `/var/nvidia/nvcam/settings`. The
naming convention is as follows:


```c
d3_<position>_<imager-name>
```


\newpage
On \dbloctonameshort <position> field is as described in the table below.

\begin{table}[h]
\begin{minipage}{\textwidth}
\centering
\caption{Camera Position Mapping for \dbloctonameshort}
\label{}
\resizebox{0.33\textwidth}{!}{%
\begin{tabular}{@{}lll@{}}
\toprule

Sensor ID & Position Field \\

\midrule

Sensors 0-3  & 0,1,2,3 \\
Sensors 4-7  & 4,5,6,7 \\
Sensors 8-11  & 8,9,10,11 \\
Sensors 12-15  & 12,13,14,15 \\


\bottomrule
\end{tabular}%
}
\end{minipage}
\end{table}


The <imager-name> can be any supported imager (e.g. \ovnone, \imxnone,
\imxrcmnone, etc.). For example, an \ovnone plugged into port 0 on
\cicnameshort would use the following badge:

```c
d3_0_ov10640
```

## Installing Argus Camera Application

\hypertarget{argus-camera-installation}{\empty} The `argus_camera`
application is provided as a sample application from \nvidia as part
of the `tegra_multimedia_api` package. The source code for this
application is provided along with other examples. This is an
excellent starting point for developing `libargus` based
applications. This package is not installed by default.

This application is not required. It is, however, highly educational
and a great tool for testing cameras.

Use the \sdkmanager to install the Jetson SDK components. Be sure to
*uncheck* Jetson OS! If you forget to uncheck this option you must
re-install all D3 provided software.

![SDK Installer](img/sdk-installer.png "SDK Manager Installer")

\newpage

After the SDK components have been installed on the \nvjetson perform
the following steps to build and install `argus_camera` and related
utilities.


```sh
# run D3's Tegra Multimedia API build and install script
d3-build-tegra-media-api
```

## Argus Camera Use

You can start the application by opening a terminal window and executing:

```sh
argus_camera&
```

Argus Camera has a total of 4 modes. These are explained below. You can
choose different modes using the dropdown button in the top right corner
of the application.

The application will launch into "capture" mode by default. This allows
for you to view individual cameras and capture images as needed.

The second mode is "video" mode. This behaves the same way as the
"capture" mode, except it allows for you to capture videos instead
of still images.

The third mode is "multi exposure" mode. This mode shows one camera,
duplicated many times. This is primarily used to view one camera stream
multiple times.

The last mode is "multi session" mode. This allows for simultaneous viewing
of all connected cameras at once. In other words, this mode shows all of the
cameras connected to the system at once.

Please be careful to not mix up "multi exposure" and "multi session" mode.
Although similar, these serve different purposes! Although "multi exposure" does
make it appear that the system has duplicate cameras, this is not the purpose
of this mode. If testing more than one of the cameras, make sure to use
**"multi session"** mode.

## OV10640

This release includes two sensor modes for \ovnones. Mode 0 uses the
long exposure of the camera. This mode operates at 30 fps and delivers
12 bits-per-pixel of depth. The resolution is 1280x1080. Mode 1 uses three
exposures in order to form a single HDR mode capture, also running at 30 fps
at a resoltuion of 1280x1080. Below is a table of modes for the \ovnone.

\begin{table}[h]
\begin{minipage}{\textwidth}
\centering
\caption{\ovnone Sensor Modes}
\label{tab:supported-camera-modules}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}ccccl@{}}
\toprule

Sensor Mode ID &  Resolution &  Bit Depth & Frame Rate & Description\\
\midrule
0  & 1280x1080 & 12 & 30 & Linear mode \\
1  & 1280x1080 & 20 & 30 & HDR mode \\
\bottomrule
\end{tabular}%
}
\end{minipage}
\end{table}

## D3CM-IMX390

This release includes three sensor modes for SONY\textregistered{}
IMX390.

\begin{warning}
Switching of modes for this sensor currently requires a system reboot to
guarantee register settings.
\end{warning}

\begin{notice}
Raw captures from \imxnone are misaligned when using the default stride length.
Please follow the directions below to capture a correctly aligned raw capture.
\end{notice}

To capture a correctly aligned image, use the following command:
```sh
v4l2-ctl --stream-mmap --stream-count --stream-skip=16 --stream-to=out.raw -cpreferred_stride=4096 -csensor_mode=0`
```
`cpreferred_stride` must be set to 4096. This is in **bytes**, not pixels.
To view the capture correctly, the correct **pixels** must be used, which is 2048.
To bypass the VI settings in the kernel driver, which is needed after streaming
from `argus_camera`, add `bypass_mode=0` to the command line flags, as shown in the example
given below:

```sh
v4l2-ctl --set-ctrl bypass_mode=0
```

\begin{table}[h]
\begin{minipage}{\textwidth}
\centering
\caption{\imxnone Sensor Modes}
\label{tab:supported-camera-modules}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}ccccl@{}}
\toprule

Sensor Mode ID &  Resolution &  Bit Depth & Frame Rate & Description\\

\midrule

0  & 1936x1096 & 12 & 30 & Sub-pixel 1 low conversion linear mode (recommended) \\
1  & 1936x1096 & 12 & 30 & Sub-pixel 1 high conversion linear mode \\
2  & 1936x1096 & 12 & 30 & Sub-pixel 2 linear mode \\
3  & 1936x1096 & 20 & 30 & HDR mode \\
\bottomrule
\end{tabular}%
}
\end{minipage}
\end{table}

Use `argus_camera` to preview different modes. You must restart the system if
you choose to view a different mode with this camera at this time. You also may
need to explicitly set the desired mode before streaming using `v4l2-ctl` or
`argus_camera`. For example:

```bash
v4l2-ctl -csensor_mode=n # where n is the integer sensor mode
```

```bash
argus_camera --sensormode=n # where n is the integer sensor mode
```

Changing modes without rebooting may display video, but we cannot guarantee
that the camera will be configured properly at this time.

Mode 0 (sub-pixel 1 low conversion) is recommended for
most uses-cases. In low light conditions, mode 1 (sub-pixel 1 high conversion)
may be more suitable.


```sh
# View the camera in sub-pixel 1 low conversion linear mode
argus_camera --sensormode=0
```

## Frame Synchronization

This feature requires the installation of D3's `d3-camsync` Debian
package, which depends on `lua`. Installing `v4l-utils`
is recommended for setting various camera controls from the
shell. The `apt` package manager should resolve these dependencies automatically.

The version numbers in this example may not match the current
releases. Please contact D3 for the latest `d3-camsync` release.

```
sudo apt update
sudo apt install ./d3-camsync_1.2.1-1_arm64.deb
sudo apt install ./d3-camsync-dev_1.2.1-1_arm64.deb
sudo reboot
```

The default frame sync frequency is 10 Hz. This rate can be changed by
editing `/etc/d3-camsync/config.lua` and then running `sudo sync.lua`
for the changes to take effect. You do not need to restart the system
for changes to take effect.

```
vi /etc/d3-camsync/config.lua
sudo sync.lua
```

\begin{notice}

The camera module must also support frame synchronization for this
feature to work properly. At this time D3 supports frame
synchronization with \ovnone

\end{notice}

\ovnone must be placed in frame sync mode which is sometimes called slave
mode. By default, the camera operates in a free-running mode at 30
frames per second. You can set this mode using the v4l2
frame_sync_enable control from your application. This can be set from
the command line using the example below.

```
v4l2-ctl -cframe_sync_enable=1
```

Each camera can be set independently. It is not necessary to enable
frame sync on every camera; only for the cameras that should be
synchronized. To bypass the VI settings in the kernel driver, which is needed after streaming
from `argus_camera`, add `bypass_mode=0` to the command line flags, as shown in the example
given below:

```sh
v4l2-ctl --set-ctrl bypass_mode=0
```

# Sensor IDs

The sensor-id value, which is needed to identify cameras in software,
is assigned at run-time. The sensor-id can be determined based on the
number of cameras connected to the system and the ports they are
connected to. The sensor-id starts at 0 and increments for each camera
detected. The zeroth sensor-id is assigned to the camera on the lowest
numbered port. For example a camera connected to J2 will always have
sensor-id 0.

If the system is started with two cameras connected, one on J3 (the
second port) and another on J5 then the J3 camera would have sensor-id
0 and the J5 camera would have sensor-id 1.

# Known Issues

* \hypertarget{nvgst-known-issue}{\empty}`nvgstcapture` and
  `nvarguscamerasrc` have no mechanism for choosing the
  sensor-mode. On \nvxavier it seems that the sensor mode is
  unpredictable with these two tools. The `argus_camera` tool can be
  used with `--sensormode=$N` where $N is the sensor mode number
  reliably.

* The \imxnone driver does not support run-time sensor mode switching.

* The combination of \nvxavier and \cicnameshort is known to
  report a duplicate sysfs entry. This can safely be ignored and does
  not affect the system.

* Trying to stream on the \nxcnameshort with Argus with both \ovnone
  and \imxnone does not work

* Removing d3-jetson-utils requires manually editing extlinux.conf in order to
  automatically choose which kernel to automatically boot

* OP-2235: Argus camera positions above 6 intermittently cause the Argus daemon
  to report invalid sensor placement errors. Whether streams are affected seems
  to be hit-or-miss.

* OP-2236: UB960 digital reset causes Argus to report `CSIMUX_FRAME` errors
  when one stream is closed while others are still running. The running streams
  do not appear to be otherwise affected.

* OP-2239: Streaming multiple \imxnone cameras simultaneously in Argus may
  cause sequence errors according to the Argus daemon, resulting in instability
  after streams have started. In most cases the camera still streams despite
  the sequence errors, but automated scripts may see exit codes and assume
  failure. This issue does not appear to occur when streaming one camera.

* OP-2242: `argus_camera` streams intermittently start with high ISP noise.
  The stream looks very white and slightly scrambled with what look like
  scan lines throughout.  Pointing the camera at a dark scene (e.g. putting the
  lens against the table) for a few seconds will eliminate the noise.

* OP-2243: Argus camera streams occasionally time out with no video. \nvidia
  recommends staggering the start of each camera stream by at least 250 ms if
  using multiple cameras to mitigate this.

\newpage

# Change-Log

This change-log is not exhaustive. This provides a historical
reference of the major changes made between releases.

## Major Changes 4.0.0

* JetPack 4.4 supported and required

* Support for the \nxcnameshort

* Add new hardware specific bringup documentation for \nxcnameshort

* New `d3-cam-select-boot` tool for selecting cameras

* Updated \imxnone ISP tuning file

* Added \imxrcmnone ISP tuning file

* Camera drivers updates

* Remove old example scripts from d3-jetson-util package

* Improve BSP Release Notes

* Additional hardware support (see Supported Hardware)

## Major Changes 3.0.2

* Fix to makefile related to BUILD_ID

## Major Changes 3.0.1

* Virtual channel fixes for \dbloctonameshort

## Major Changes 3.0.0

* \nvjetpack 4.3 supported and required

* Virtual Channel support
  * Up to 16 cameras on \dbloctonameshort
  * Up to 4 \fpdlink cameras on \cicnameshort

* Simplified dtb file selection on \nvxavier

* camera postion for ISP overrides simplified to port index

* infinite-cam-timeout mode is enabled for Argus daemon to work out
  issue #627 on \nvxavier and occasional timeouts launching multiple
  \imxnone on Tx2 (issue #634)


## Major Changes 2.0.0

* \nvjetpack 4.2.2 supported and required

* Multiple camera models supported on RSP simultaneously

* Less complex device tree for users

* infinite-cam-timeout mode is enabled for Argus daemon to work out
  issue #627 on \nvxavier and occasional timeouts launching multiple

## Major Changes 1.3.3

This is a maintenance release that corrects an image quality problem
with \ovnone cameras.

* \ovnone: HDR support disabled until quality issues can be solved

* \ovnone: reverted to 1.3.1 tuning for better linear mode quality

## Major Changes 1.3.2

* \imxnone: improved HDR support

* \ovnone: improved HDR support

* \ovnone: fixed incorrect exposure time control

* Xavier: fixed lockups on warm boots with \ovnone

* frame sync: \rspnameshort now supports frame synchronization


## Major Changes 1.3.1

* Adds libnvodm_imager.so from \nvidia to correct the sensor-id
  assignment issue.

## Major Changes 1.3.0

* There are no restrictions on camera ports for \rspnameshort
  kits. Any number of cameras may be connected using any available
  port. (Note: for \cicnameshort you must connect a single camera to J6).

* The base system is upgraded to Ubuntu 18.04 (since 1.0.0). Earlier
  releases were based on Ubuntu 16.04.

* There is no longer a default username and password. The user account
  is created when you first start the system after installing \nvjetpack 4.2.

* D3 recommends the use of the `argus_camera` application that is
  available from the tegra_multimedia_api package that can be
  installed from \nvjetpack installer. The application has full
  source code and is easy to use for testing and evaluating
  cameras. See the \hyperlink{argus-camera-installation}{installation section}
  for instructions on building and installing `argus_camera`.

* An experimental patch for publishing the offset of the timestamp for
  frames vs. the system clock in included. See
  \hyperlink{timestamp-patch}{here} for more details.

* A patch is included that corrects an \nvidia issue related to
  sensor-id assignments.

* A patch is included that corrects an \nvidia issue related to PWL
  decompression for HDR camera modes.

* The "warm boot" camera detection issue has been corrected. Cameras
  are detected on \fpdlink based systems from cold boot and from warm
  boot.

* \ovnone: HDR mode added (see \hyperlink{nvgst-known-issue}{known issues})

* \ovnone: supports multiple modes (linear and HDR)

* \imxnone: HDR mode added

* \imxnone: supports multiple modes with the restriction that the mode
  must not be changed at run-time. To switch modes a system restart is
  required.
