#!/bin/bash
set -e

# Unset values that are not deliberate and applicable to the BSP build process
# This BUILD_NUMBER will impact the Kernel build process unintentionally
unset BUILD_NUMBER

# Make sure that all mktemp and similar create files inside the assigned workspace
WORKSPACE_TMP=${WORKSPACE:-${PWD}}/build/tmp
mkdir -p ${WORKSPACE_TMP}
export TMPDIR="${WORKSPACE_TMP}"
L4T_DIRECTORY=/opt/nvidia/JetPack_4.6.1_Linux_JETSON_AGX_XAVIER/Linux_for_Tegra
OTHER_ARGS=()
for arg in "$@"
do
	case $arg in
		--with-l4t=*)
		L4T_DIRECTORY="${arg#*=}"
		shift
		;;
		--help|--h)
		echo "Builds the files to allow utilization of the D3 BSP"
		echo "Usage: jenkins-build [OPTION]=DIRECTORY"
 		echo "--with-l4t = Allows the user to specify the Linux_for_Tegra host directory"
		exit 0
		;;
		*)
		OTHER_ARGS+=("$1")
		shift
		;;
	esac
done

echo "# L4T Host Directory: $L4T_DIRECTORY"
if [ ! -z "$OTHER_ARGS" ]
then
	echo "# Syntax Error in $OTHER_ARGS, check to ensure that the flag is correct."
fi
echo "Build start: $(date)"

# Do a shallow clone of submodules
echo "Starting submodule init: $(date)"
git submodule update --init --recursive --depth 1
echo "Submodule init complete: $(date)"

# Make sure G-16447 has been applied
if ! grep -E -q 'KBUILD_DEFCONFIG.+\bd3_defconfig\b' kernel/kernel-4.9/arch/arm64/Makefile ; then
    cat <<EOT 1>&2

                                 ********
defconfig is not set properly --- please apply G-16447 to this branch.
                                 ********
Aborting.
EOT
    exit 1
fi

# Generate the configure script from configure.ac
./bootstrap
CONFIG_SHELL=/bin/bash /bin/bash ./configure \
    --with-l4t=$L4T_DIRECTORY

# Assumes arm64, which Jetson always is ;) .
ARCH=arm64 make linux-defconfig

# Build all the things in all the land.
# Normal build
export CONCURRENCY_LEVEL="$(grep -c '^processor' /proc/cpuinfo)"
make -j"$CONCURRENCY_LEVEL" release-zip
echo "Finished building at $(date)"
